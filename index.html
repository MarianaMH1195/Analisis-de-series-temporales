<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Detective de Datos - Aprende an√°lisis de series temporales de forma interactiva">
    <title>üîç Detective de Datos | An√°lisis de Series Temporales</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="styles.css?v=3.1">
</head>

<body>
    <div class="app-container">
        <!-- ========================================
             HEADER
        ======================================== -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">üîç</span>
                    <span class="logo-text">Detective de Datos</span>
                    <span class="logo-subtitle">Caso Retail 2022</span>
                </div>
                <nav class="header-nav">
                    <button class="btn-icon" id="btnLeaderboard" title="Mis Expedientes"
                        aria-label="Ver historial">üìã</button>
                    <button class="btn-icon" id="btnTutorial" title="C√≥mo Jugar" aria-label="Ver tutorial">‚ùì</button>
                    <button class="btn-icon" id="btnSettings" title="Configuraci√≥n"
                        aria-label="Configuraci√≥n">‚öôÔ∏è</button>
                </nav>
            </div>
        </header>



        <!-- ========================================
             MAIN CONTENT
        ======================================== -->
        <main class="main-content">

            <!-- ========================================
                 SCREEN 1: MISSION SELECT
            ======================================== -->
            <div id="missionSelectScreen" class="mission-screen active">
                <!-- Player Stats Header -->
                <div class="player-stats-bar">
                    <div class="player-rank">
                        <div class="rank-icon" id="rankIcon">üå±</div>
                        <div class="rank-info">
                            <h3>Rango Actual</h3>
                            <div class="rank-name" id="currentRank">Novato</div>
                        </div>
                    </div>

                    <div class="player-xp">
                        <div class="xp-label">
                            <span>Progreso de Nivel</span>
                            <span><span id="totalXP">0</span> XP / 1650</span>
                        </div>
                        <div class="xp-bar">
                            <div class="xp-fill" id="xpProgressFill" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="player-missions">
                        <div class="missions-count" id="missionsCompleted">0/7</div>
                        <div class="text-muted text-sm">Misiones</div>
                    </div>
                </div>

                <!-- Missions Grid -->
                <h2 class="section-title mb-lg">Expedientes Disponibles</h2>
                <div class="missions-grid" id="missionsGrid">
                    <!-- Injected by JS -->
                </div>

                <!-- Achievements Section -->
                <div class="achievements-section">
                    <h3>üèÖ Medallas y Logros</h3>
                    <div class="achievements-container" id="achievementsContainer">
                        <!-- Injected by JS -->
                    </div>
                </div>
            </div>

            <!-- ========================================
                 SCREEN 2: MISSION PLAY
            ======================================== -->
            <div id="missionPlayScreen" class="mission-screen">
                <!-- Mission Header -->
                <div class="mission-play-header">
                    <button class="btn btn-secondary btn-sm" id="btnBackToMissions">
                        ‚Üê Volver
                    </button>
                    <div class="mission-play-title-group" style="flex: 1; margin-left: 1rem;">
                        <h1 id="missionPlayTitle">T√≠tulo Misi√≥n</h1>
                        <p class="mission-play-subtitle" id="missionPlaySubtitle">Subt√≠tulo</p>
                    </div>
                    <div class="mission-play-meta">
                        <span class="mission-difficulty" id="missionPlayDifficulty">‚≠ê‚≠ê</span>
                        <span class="mission-icon" id="missionPlayIcon">üì¶</span>
                    </div>
                </div>

                <!-- Narrative Section -->
                <div class="mission-narrative">
                    <h3>üìÅ Briefing de la Misi√≥n</h3>
                    <p id="missionNarrative">...</p>

                    <div class="mission-objectives mt-md">
                        <h4>Objetivos:</h4>
                        <ul id="missionObjectives"></ul>
                    </div>
                </div>

                <!-- Chart Section -->
                <section class="chart-section mb-xl">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <span>üìä</span>
                            <span id="chartTitleText">Datos del Caso</span>
                        </h3>
                        <div class="chart-controls">
                            <button id="btnZoomIn" title="Acercar">üîç+</button>
                            <button id="btnZoomOut" title="Alejar">üîç-</button>
                            <button id="btnResetChart" title="Restablecer">‚Üª</button>
                        </div>
                    </div>
                    <div class="mission-chart-container">
                        <div class="mission-chart-wrapper">
                            <canvas id="missionChart"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Question Section -->
                <div class="question-progress" id="questionProgress">Pregunta 1 de 3</div>

                <div id="questionContainer">
                    <!-- Question injected by JS -->
                </div>

                <!-- Footer Tools -->
                <div class="mission-footer mt-xl text-center">
                    <button class="btn btn-secondary" id="btnRecapNarrative"
                        onclick="document.querySelector('.mission-narrative').scrollIntoView({behavior: 'smooth'})">
                        üìú Ver Briefing
                    </button>
                    <button class="btn btn-secondary" id="btnSandboxModeInline">
                        üß™ Abrir Sandbox
                    </button>
                </div>
            </div>

        </main>



        <!-- ========================================
             MODAL FEEDBACK
        ======================================== -->
        <div class="modal" id="feedbackModal">
            <div class="modal-backdrop" id="modalBackdrop"></div>
            <div class="modal-content">
                <div class="modal-icon" id="modalIcon">‚úÖ</div>
                <h3 id="modalTitle">¬°Correcto!</h3>
                <p id="modalMessage">Has identificado el patr√≥n correctamente.</p>
                <div class="modal-actions">
                    <button class="btn btn-primary" id="btnModalClose">Continuar</button>
                </div>
            </div>
        </div>

        <!-- ========================================
             LEADERBOARD MODAL
        ======================================== -->
        <div class="modal" id="leaderboardModal">
            <div class="modal-backdrop" id="leaderboardBackdrop"></div>
            <div class="modal-content" style="max-width: 600px;">

                <h3>Historial de Expedientes</h3>
                <div id="leaderboardContent" style="text-align: left; margin: 1rem 0;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--primary);">
                                <th style="padding: 0.75rem; text-align: center;">#</th>
                                <th style="padding: 0.75rem; text-align: left;">Detective</th>
                                <th style="padding: 0.75rem; text-align: center;">Puntos</th>
                                <th style="padding: 0.75rem; text-align: center;">Tiempo</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                    <p id="leaderboardEmpty" class="text-muted text-center" style="margin-top: 1rem;">No hay
                        puntuaciones guardadas a√∫n.</p>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="btnClearLeaderboard">üóëÔ∏è Limpiar</button>
                    <button class="btn btn-primary" id="btnCloseLeaderboard">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- ========================================
             NAME INPUT MODAL
        ======================================== -->
        <div class="modal" id="nameModal">
            <div class="modal-backdrop"></div>
            <div class="modal-content">
                <div class="modal-icon">üéâ</div>
                <h3>¬°Felicidades!</h3>
                <p>Has completado el caso. Ingresa tu nombre para el ranking:</p>
                <div class="form-group" style="text-align: left;">
                    <input type="text" id="playerNameInput" class="form-input" placeholder="Tu nombre..."
                        maxlength="20">
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="btnSkipName">Omitir</button>
                    <button class="btn btn-primary" id="btnSaveName">Guardar</button>
                </div>
            </div>
        </div>

        <!-- ========================================
             MISSION COMPLETE MODAL
        ======================================== -->
        <div class="modal mission-complete-modal" id="missionCompleteModal">
            <div class="modal-backdrop"></div>
            <div class="modal-content">
                <div class="complete-celebration">üéâ</div>
                <h2 id="completeMissionTitle">Misi√≥n Completada</h2>

                <div class="complete-xp">
                    <h2>+<span id="completeXPEarned">0</span> XP</h2>
                    <p>Total: <span id="completeTotalXP">0</span> XP</p>
                </div>

                <div class="complete-stats">
                    <div class="complete-stat">
                        <div class="complete-stat-value" id="completeCorrectAnswers">0/0</div>
                        <div class="complete-stat-label">Aciertos</div>
                    </div>
                </div>

                <div class="complete-achievement">
                    <div class="complete-achievement-icon" id="completeAchievementIcon">üèÖ</div>
                    <h3 class="complete-achievement-name" id="completeAchievementName">Logro</h3>
                    <p class="complete-achievement-desc" id="completeAchievementDesc">Descripci√≥n</p>
                </div>

                <div class="complete-actions">
                    <button class="btn btn-secondary" id="btnMissionCompleteClose">Cerrar</button>
                    <button class="btn btn-primary" id="btnNextMission">Siguiente Misi√≥n ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- ========================================
             SANDBOX MODAL
        ======================================== -->
        <div class="modal" id="sandboxModal">
            <div class="modal-backdrop" id="sandboxBackdrop"></div>
            <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-icon">üß™</div>
                <h3>Modo Sandbox</h3>
                <p class="mb-lg">Explora los datos libremente sin restricciones del juego.</p>

                <div style="text-align: left;">
                    <!-- Chart Type Selector -->
                    <div class="form-group">
                        <label class="form-label">Tipo de Visualizaci√≥n:</label>
                        <select id="sandboxChartType" class="form-select">
                            <option value="line">üìà L√≠nea (Serie Temporal)</option>
                            <option value="bar">üìä Barras (Agregaci√≥n Mensual)</option>
                            <option value="scatter">‚ö´ Puntos (Dispersi√≥n)</option>
                        </select>
                    </div>

                    <!-- Overlays -->
                    <div class="form-group">
                        <label class="form-label">Capas adicionales:</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); cursor: pointer;">
                                <input type="checkbox" id="sandboxShowTrend"> üìè L√≠nea de Tendencia
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); cursor: pointer;">
                                <input type="checkbox" id="sandboxShowMovingAvg"> üìâ Media M√≥vil (7 d√≠as)
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); cursor: pointer;">
                                <input type="checkbox" id="sandboxShowAnomalies"> üö® Marcar Anomal√≠as
                            </label>
                        </div>
                    </div>

                    <!-- Date Range -->
                    <div class="form-group">
                        <label class="form-label">Rango de Datos:</label>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <input type="date" id="sandboxStartDate" class="form-input" value="2022-01-01"
                                style="flex: 1;">
                            <span>hasta</span>
                            <input type="date" id="sandboxEndDate" class="form-input" value="2022-10-31"
                                style="flex: 1;">
                        </div>
                    </div>

                    <!-- Stats Display -->
                    <div id="sandboxStats" class="stats-grid" style="margin: 1.5rem 0;">
                        <div class="stat-card">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-label">Media</div>
                            <div class="stat-value" id="sandboxMean">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìà</div>
                            <div class="stat-label">M√°ximo</div>
                            <div class="stat-value" id="sandboxMax">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìâ</div>
                            <div class="stat-label">M√≠nimo</div>
                            <div class="stat-value" id="sandboxMin">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìê</div>
                            <div class="stat-label">Desv. Est√°ndar</div>
                            <div class="stat-value" id="sandboxStd">--</div>
                        </div>
                    </div>

                    <!-- Chart Preview -->
                    <div
                        style="background: var(--gray-50); border-radius: var(--radius-md); padding: 1rem; margin: 1rem 0;">
                        <canvas id="sandboxChart" style="width: 100%; height: 300px;"></canvas>
                    </div>
                </div>

            </div>
        </div>

        <!-- ========================================
             TUTORIAL MODAL
        ======================================== -->
        <div class="modal" id="tutorialModal">
            <div class="modal-backdrop" id="tutorialBackdrop"></div>
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-icon">üïµÔ∏è</div>
                <h3>C√≥mo Jugar</h3>

                <div class="tutorial-steps">
                    <div class="tutorial-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h4>Analiza el Caso</h4>
                            <p>Lee atentamente el briefing y observa los gr√°ficos de datos reales.</p>
                        </div>
                    </div>
                    <div class="tutorial-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h4>Responde las Preguntas</h4>
                            <p>Usa las herramientas de visualizaci√≥n para encontrar las respuestas correctas.</p>
                        </div>
                    </div>
                    <div class="tutorial-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h4>Sube de Rango</h4>
                            <p>Gana XP completando misiones y desbloquea nuevos desaf√≠os m√°s dif√≠ciles.</p>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-primary" id="btnCloseTutorial">¬°Entendido!</button>
                </div>
            </div>
        </div>

        <!-- ========================================
             SETTINGS MODAL
        ======================================== -->
        <div class="modal" id="settingsModal">
            <div class="modal-backdrop" id="settingsBackdrop"></div>
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-icon">‚öôÔ∏è</div>
                <h3>Configuraci√≥n</h3>

                <div class="settings-group">
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Sonido</h4>
                            <p>Efectos de sonido y m√∫sica</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="settingSoundToggle" checked>
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>Modo Oscuro</h4>
                            <p>Interfaz oscura para descanso visual</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="settingDarkModeToggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-danger-zone">
                    <h4>Zona de Peligro</h4>
                    <button class="btn btn-danger-outline" id="btnResetProgress">
                        ‚ö†Ô∏è Reiniciar Todo el Progreso
                    </button>
                    <p class="text-xs text-muted mt-sm">Esta acci√≥n no se puede deshacer.</p>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-primary" id="btnCloseSettings">Guardar y Cerrar</button>
                </div>
            </div>
        </div>

    </div>

    <!-- ========================================
         SCRIPTS (CDN)
    ======================================== -->
    <!-- Chart.js 4.4 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Chart.js Annotation Plugin -->
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- Anime.js -->
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>
    <!-- Numeral.js -->
    <script src="https://cdn.jsdelivr.net/npm/numeral@2.0.6/numeral.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <!-- Mission System Data -->
    <script src="datasets.js"></script>
    <script src="missions.js"></script>
    <script src="mission-system.js"></script>

    <!-- Game Logic -->
    <script src="game-logic.js"></script>

    <!-- Force remove icon script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Remove modal icon
            const modalIcon = document.querySelector('#leaderboardModal .modal-icon');
            if (modalIcon) modalIcon.remove();

            // Just in case, try to clear any cached HTML content if possible (limited control)
            console.log('Icon remover script active');
        });
    </script>
</body>

</html>